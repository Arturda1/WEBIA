{% extends "base.html" %}
{% block content %}
<h2>üì¶ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É</h2>
<form method="post">
  <div class="mb-3">
    <label>–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏:</label>
    <input type="date" name="date" class="form-control" required>
  </div>

  <div class="mb-3">
    <label>–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç:</label>
    <select name="contractor" class="form-select" onchange="this.form.submit()">
      <option value="">‚Äî</option>
      {% for c in contractors %}
        <option value="{{ c }}" {% if c == selected_contractor %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
    <small>–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–≥–æ:</small>
    <input type="text" name="new_contractor" class="form-control" placeholder="–ù–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç">
  </div>

  <div class="mb-3">
    <label>–ò—Å—Ç–æ—á–Ω–∏–∫ –æ–ø–ª–∞—Ç—ã:</label>
    <input type="text" name="payment_source" class="form-control" value="{{ payment_sources[0] if payment_sources else '' }}">
    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤:</label>
    <input type="text" name="expense_category" class="form-control" value="{{ expense_categories[0] if expense_categories else '' }}">
    <label>–í–∏–¥ —Ä–∞—Å—Ö–æ–¥–æ–≤:</label>
    <input type="text" name="expense_type" class="form-control" value="{{ expense_types[0] if expense_types else '' }}">
    <label>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
    <input type="number" name="delivery" step="0.01" class="form-control" value="0">
  </div>

  <hr>
  <h4>üßæ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h4>
  <div id="materials-list"></div>
  <button type="button" onclick="addMaterial()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button>

  <hr>
  <button type="submit" name="mode" value="save">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É</button>
  <a href="{{ url_for('dashboard') }}">‚¨Ö –ù–∞–∑–∞–¥</a>
</form>

<script>
  let index = 0;
  function addMaterial() {
    const container = document.getElementById("materials-list");
    const html = `
      <div class="row mb-3 border rounded p-3 mt-3">
        <div class="col">
          <label>–ú–∞—Ç–µ—Ä–∏–∞–ª:</label>
          <select name="material_${index}" class="form-select">
            <option value="">‚Äî</option>
            {% for m in materials %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
          <input type="text" name="new_material_${index}" class="form-control mt-1" placeholder="–∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π">
        </div>
        <div class="col">
          <label>–ï–¥. –∏–∑–º.:</label>
          <input name="unit_${index}" type="text" class="form-control" value="—à—Ç">
        </div>
        <div class="col">
          <label>–ö–æ–ª-–≤–æ —É–ø–∞–∫–æ–≤–æ–∫:</label>
          <input name="qty_packs_${index}" type="number" step="0.01" class="form-control" oninput="recalculatePrice(${index})">
        </div>
        <div class="col">
          <label>–ö–æ–ª-–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ:</label>
          <input name="units_per_pack_${index}" type="number" step="0.01" class="form-control">
        </div>
        <div class="col">
          <label>–¶–µ–Ω–∞ (–∑–∞ —É–ø–∞–∫–æ–≤–∫—É):</label>
          <input name="price_per_pack_${index}" type="number" step="0.01" class="form-control" oninput="recalculatePrice(${index})">
        </div>
        <div class="col">
          <label>–°—Ç–æ–∏–º–æ—Å—Ç—å (–æ–±—â–∞—è):</label>
          <input name="total_cost_${index}" type="number" step="0.01" class="form-control">
        </div>
        <div class="col">
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
          <input name="comment_${index}" type="text" class="form-control">
        </div>
      </div>`;
    container.insertAdjacentHTML("beforeend", html);
    index++;
  }
  // –∞–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏
  window.onload = addMaterial;
</script>
{% endblock %}
