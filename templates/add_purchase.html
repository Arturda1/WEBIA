{% extends "base.html" %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É{% endblock %}

{% block content %}
<h2>üì¶ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏</h2>

<form method="post">

  <!-- üìÖ –î–∞—Ç–∞ –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫ -->
  <div class="mb-3">
    <label class="form-label">–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏:</label>
    <input type="date" name="date" class="form-control" required>
  </div>

  <div class="mb-3">
    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞:</label>
    <select name="contractor" class="form-select">
      <option value="">‚Äî</option>
      {% for c in contractors %}
      <option value="{{ c }}" {% if c == selected_contractor %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
    <small class="form-text text-muted">–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–≥–æ:</small>
    <input type="text" name="new_contractor" class="form-control" placeholder="–ù–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç">
  </div>

  <button name="mode" value="refresh" class="btn btn-secondary mb-4">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—É</button>

  <!-- üßæ –ò—Å—Ç–æ—á–Ω–∏–∫ –æ–ø–ª–∞—Ç—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏ –≤–∏–¥ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
  <div class="row mb-3">
    <div class="col">
      <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –æ–ø–ª–∞—Ç—ã:</label>
      <input list="source_options" name="payment_source" class="form-control">
      <datalist id="source_options">
        {% for p in payment_sources %}
        <option value="{{ p }}">
        {% endfor %}
      </datalist>
    </div>
    <div class="col">
      <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤:</label>
      <input list="category_options" name="expense_category" class="form-control">
      <datalist id="category_options">
        {% for e in expense_categories %}
        <option value="{{ e }}">
        {% endfor %}
      </datalist>
    </div>
    <div class="col">
      <label class="form-label">–í–∏–¥ —Ä–∞—Å—Ö–æ–¥–æ–≤:</label>
      <input list="type_options" name="expense_type" class="form-control">
      <datalist id="type_options">
        {% for t in expense_types %}
        <option value="{{ t }}">
        {% endfor %}
      </datalist>
    </div>
  </div>

  <!-- üöö –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ -->
  <div class="mb-4">
    <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å):</label>
    <input type="number" step="0.01" name="delivery" class="form-control">
  </div>

  <!-- üì¶ –ü–æ–∑–∏—Ü–∏–∏ -->
  <h5>üßæ –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</h5>
  <div id="positions"></div>
  <button type="button" class="btn btn-outline-primary mt-2" onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>

  <br><br>
  <button name="mode" value="save" type="submit" class="btn btn-success">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É</button>
  <a href="/dashboard" class="btn btn-link">‚¨Ö –ù–∞–∑–∞–¥</a>

</form>

<script>
let index = 0;
const existingMaterials = {{ materials | tojson }};

function addRow() {
  const container = document.getElementById("positions");

  const row = document.createElement("div");
  row.classList.add("border", "p-3", "mb-3", "rounded");

  row.innerHTML = `
    <div class="mb-2"><b>–ü–æ–∑–∏—Ü–∏—è #${index + 1}</b></div>
    <div class="row mb-2">
      <div class="col">
        <label>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª:</label>
        <select name="material_${index}" class="form-select">
          <option value="">‚Äî</option>
          ${existingMaterials.map(m => `<option value="${m}">${m}</option>`).join('')}
        </select>
      </div>
      <div class="col">
        <label>–ò–ª–∏ –Ω–æ–≤—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª:</label>
        <input name="new_material_${index}" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
      </div>
    </div>
    <div class="row mb-2">
      <div class="col">
        <label>–ï–¥. –∏–∑–º.:</label>
        <input name="unit_${index}" class="form-control" value="—à—Ç">
      </div>
      <div class="col">
        <label>–ö–æ–ª-–≤–æ —É–ø–∞–∫–æ–≤–æ–∫:</label>
        <input name="qty_packs_${index}" type="number" step="0.01" class="form-control">
      </div>
      <div class="col">
        <label>–ö–æ–ª-–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ:</label>
    <input name="qty_packs_${index}" type="number" step="0.01" class="form-control" oninput="recalculatePrice(${index})">
      </div>
    </div>
    <div class="row mt-2">
      <div class="col">
        <label>–¶–µ–Ω–∞ (–∑–∞ —É–ø–∞–∫–æ–≤–∫—É):</label>
        <input name="price_per_pack_${index}" type="number" step="0.01" class="form-control">
      </div>
      <div class="col">
    <input name="total_cost_${index}" type="number" step="0.01" class="form-control" oninput="recalculatePrice(${index})">
        <input name="total_cost_${index}" type="number" step="0.01" class="form-control">
      </div>
      <div class="col">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <input name="comment_${index}" class="form-control">
      </div>
    </div>
  `;
  container.appendChild(row);
  index++;
}
</script>

<script>
    function recalculatePrice(index) {
      const price = document.querySelector(`input[name="price_per_pack_${index}"]`);
      const cost = document.querySelector(`input[name="total_cost_${index}"]`);
      const qty = document.querySelector(`input[name="qty_packs_${index}"]`);
    
      if (price && cost && qty && !price.value) {
        const total = parseFloat(cost.value || 0);
        const amount = parseFloat(qty.value || 0);
        if (amount > 0) {
          price.value = (total / amount).toFixed(4);
        }
      }
    }
    </script>
    
{% endblock %}
